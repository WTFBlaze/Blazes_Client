using Blaze.API.QM;
using Blaze.Utils.VRChat;
using System;
using UnhollowerRuntimeLib;
using UnityEngine;
using VRC.SDKBase;

namespace Blaze.Modules
{
    class ItemSteal : BModule
    {
        private QMToggleButton ToggleButton;

        public override void Start()
        {
            ClassInjector.RegisterTypeInIl2Cpp<BlazesItemStealer>();
        }

        public override void QuickMenuUI()
        {
            ToggleButton = new QMToggleButton(BlazeMenu.Exploits2, 2, 0, "Item Stealer", delegate
            {
                if (BlazeInfo.BlazesComponents.GetComponent<BlazesItemStealer>() == null)
                {
                    BlazeInfo.BlazesComponents.AddComponent<BlazesItemStealer>();
                }
            }, delegate
            {
                if (BlazeInfo.BlazesComponents.GetComponent<BlazesItemStealer>() != null)
                {
                    UnityEngine.Object.DestroyObject(BlazeInfo.BlazesComponents.GetComponent<BlazesItemStealer>());
                }
            }, "Forcefully steal items from other people so they cannot hold them.");
        }

        public override void LocalPlayerLoaded()
        {
            if (ToggleButton != null)
            {
                ToggleButton.SetToggleState(false, true);
            }
        }
    }

    public class BlazesItemStealer : MonoBehaviour
    {
        public BlazesItemStealer(IntPtr id) : base(id) { }

        public void Update()
        {
            try
            {
                if (!WorldUtils.IsInRoom()) return;
                foreach (VRC_Pickup vrc_Pickup in BlazeInfo.CachedPickups)
                {
                    if (Networking.GetOwner(vrc_Pickup.gameObject) != Networking.LocalPlayer)
                    {
                        Networking.SetOwner(Networking.LocalPlayer, vrc_Pickup.gameObject);
                    }
                }
            }
            catch {}
        }
    }
}
