using Blaze.API.QM;
using Blaze.Configs;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using UnhollowerRuntimeLib;
using UnityEngine;
using VRC;
using VRC.SDKBase;

namespace Blaze.Modules
{
    class ItemOrbit : BModule
    {
        private static QMToggleButton ToggleButton;

        public override void Start()
        {
            ClassInjector.RegisterTypeInIl2Cpp<BlazeItemOrbit>();
        }

        public override void QuickMenuUI()
        {
            ToggleButton = new QMToggleButton(BlazeMenu.Exploits, 1, 0, "Item Orbit", delegate
            {
                BlazeInfo.BlazesComponents.AddComponent<BlazeItemOrbit>();
            }, delegate
            {
                UnityEngine.Object.Destroy(BlazeInfo.BlazesComponents.GetComponent<BlazeItemOrbit>());
            }, "Toggle item orbiting around your target");
        }

        public override void LocalPlayerLoaded()
        {
            BlazeInfo.CachedPickups = UnityEngine.Object.FindObjectsOfType<VRC_Pickup>();
        }

        public override void PlayerLeft(Player player)
        {
            if (player == BlazeInfo.Target)
            {
                ToggleButton.SetToggleState(false, true);
            }
        }
    }

    public class BlazeItemOrbit : MonoBehaviour
    {
        public BlazeItemOrbit(IntPtr id) : base(id) { }

        public void Update()
        {
            try
            {
                if (VRCPlayer.field_Internal_Static_VRCPlayer_0 == null || BlazeInfo.Target == null) return;
                /*if (BlazeInfo.CachedPickups == null)
                {
                    BlazeInfo.CachedPickups = UnityEngine.Object.FindObjectsOfType<VRC_Pickup>();
                }*/
                GameObject obj = new();
                if (Config.Main.OrbitAnnoyanceMode)
                {
                    Transform transform = obj.transform;
                    Player targetPlayer = BlazeInfo.Target;
                    transform.position = ((targetPlayer?.field_Private_VRCPlayerApi_0) ?? Networking.LocalPlayer).GetTrackingData(0).position;
                }
                else
                {
                    Transform transform2 = obj.transform;
                    Player targetPlayer2 = BlazeInfo.Target;
                    transform2.position = ((targetPlayer2 != null) ? targetPlayer2.transform.position : VRCPlayer.field_Internal_Static_VRCPlayer_0.transform.position) + new Vector3(0f, 0.2f, 0f);
                }
                obj.transform.Rotate(new Vector3(0f, 360f * Time.time * Config.Main.ItemOrbitSpeed, 0f));
                foreach (VRC_Pickup vrc_Pickup in BlazeInfo.CachedPickups)
                {
                    if (Networking.GetOwner(vrc_Pickup.gameObject) != Networking.LocalPlayer)
                    {
                        Networking.SetOwner(Networking.LocalPlayer, vrc_Pickup.gameObject);
                    }
                    vrc_Pickup.transform.position = obj.transform.position + obj.transform.forward * Config.Main.ItemOrbitSize;
                    obj.transform.Rotate(new Vector3(0f, 360 / BlazeInfo.CachedPickups.Length, 0f));
                }
                Destroy(obj);
            }
            catch {}
        }
    }
}
