using Blaze.API.QM;
using Blaze.Configs;
using Blaze.Utils.VRChat;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using UnhollowerRuntimeLib;
using UnityEngine;

namespace Blaze.Modules
{
    class PlayerOrbit : BModule
    {
        internal static QMToggleButton ToggleButton;

        public override void Start()
        {
            ClassInjector.RegisterTypeInIl2Cpp<BlazePlayerOrbit>();
        }

        public override void QuickMenuUI()
        {
            ToggleButton = new QMToggleButton(BlazeMenu.Exploits, 2, 0, "Player Orbit", delegate
            {
                BlazeInfo.BlazesComponents.AddComponent<BlazePlayerOrbit>();
            }, delegate
            {
                UnityEngine.Object.Destroy(BlazeInfo.BlazesComponents.GetComponent<BlazePlayerOrbit>());
                if (ToggleButton != null && !Flight.FlightState && PlayerUtils.CurrentUser().gameObject.GetComponent<CharacterController>() != null) 
                {
                    PlayerUtils.CurrentUser().gameObject.GetComponent<CharacterController>().enabled = true;
                }
            }, "Toggle oribiting yourself around the target");
        }

        public override void SceneInitialized(int buildIndex, string sceneName)
        {
            if (ToggleButton != null && buildIndex == -1)
            {
                ToggleButton.SetToggleState(false, true);
            }
        }
    }

    public class BlazePlayerOrbit : MonoBehaviour
    {
        public BlazePlayerOrbit(IntPtr id) : base(id) {}

        public void Update()
        {
            try
            {
                if (BlazeInfo.Target == null || BlazeInfo.Target != null && BlazeInfo.Target.GetUserID() == PlayerUtils.CurrentUser().GetUserID()) return;
                if (PlayerUtils.CurrentUser().gameObject.GetComponent<CharacterController>().enabled != false)
                {
                    PlayerUtils.CurrentUser().gameObject.GetComponent<CharacterController>().enabled = false;
                }
                float axis = Input.GetAxis("Horizontal");
                float axis2 = Input.GetAxis("Vertical");
                if (axis < -0.1f || axis > 0.1f || axis2 < -0.1f || axis2 > 0.1f || Input.GetKey(KeyCode.W) || Input.GetKey(KeyCode.A) || Input.GetKey(KeyCode.S) || Input.GetKey(KeyCode.D))
                {
                    PlayerOrbit.ToggleButton.SetToggleState(false, true);
                    return;
                }
                GameObject obj = new();
                Vector3 vector = Config.Main.OrbitAnnoyanceMode ? BlazeInfo.Target.GetVRCPlayerApi().GetBonePosition(HumanBodyBones.Head) : BlazeInfo.Target.transform.position;
                obj.transform.position = vector;
                obj.transform.Rotate(new Vector3(0f, 1f, 0f), Time.time * Config.Main.PlayerOrbitSpeed * 90f);
                VRCPlayer.field_Internal_Static_VRCPlayer_0.transform.position = obj.transform.position + obj.transform.forward * Config.Main.PlayerOrbitSize;
                Destroy(obj);
            }
            catch {}
        }
    }
}
